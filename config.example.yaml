# Feishu Webhook Bot Configuration
# ==================================
#
# This is the main configuration file for the Feishu Webhook Bot.
# Edit this file to configure webhooks, scheduler, plugins, logging, and more.
#
# Features:
# - Environment variable substitution: ${VAR_NAME} or ${VAR_NAME:default}
# - Multiple webhook endpoints
# - Task scheduling and automation
# - Plugin system with hot-reload
# - Message bridge for cross-platform forwarding
# - Multi-environment configuration

# ==============================================================================
# Webhook Configuration
# ==============================================================================
# Define one or more webhook endpoints to send messages to.
webhooks:
  - name: "default"
    url: "${FEISHU_WEBHOOK_URL:https://open.feishu.cn/open-apis/bot/v2/hook/YOUR_WEBHOOK_URL}"
    secret: "${FEISHU_WEBHOOK_SECRET:}"  # Optional: webhook signing secret
    enabled: true

  # Example: Additional webhook for alerts
  # - name: "alerts"
  #   url: "${FEISHU_ALERTS_WEBHOOK_URL}"
  #   secret: "your-secret-key"
  #   enabled: true

# ==============================================================================
# General Settings
# ==============================================================================
general:
  bot_name: "Feishu Bot"
  description: "Automated notification and task bot"
  version: "2.0.0"

# ==============================================================================
# Scheduler Configuration
# ==============================================================================
# Configure the task scheduler for running periodic jobs.
scheduler:
  enabled: true
  timezone: "Asia/Shanghai"  # Use your timezone (e.g., "America/New_York", "Europe/London")
  job_store_type: "memory"   # Options: "memory" or "sqlite"
  job_store_path: null       # Required if job_store_type is "sqlite" (e.g., "data/jobs.db")
  job_defaults:
    coalesce: true
    max_instances: 3
    misfire_grace_time: 60

# ==============================================================================
# Plugin System Configuration
# ==============================================================================
# Configure the plugin system and hot-reload behavior.
plugins:
  enabled: true
  plugin_dir: "plugins"  # Directory containing plugin files
  auto_reload: true      # Enable hot-reload of plugins
  reload_delay: 1.0      # Delay in seconds before reloading after file change

  # Plugin-specific settings (optional)
  plugin_settings:
    # RSS Subscription Plugin with Daily Report
    - plugin_name: "rss-subscription"
      enabled: true
      priority: 10
      settings:
        # Feed Management
        feeds:
          - name: "Hacker News"
            url: "https://hnrss.org/frontpage"
            check_interval_minutes: 30
            enabled: true
            max_entries: 10
            tags: ["tech", "news"]
          - name: "GitHub Trending"
            url: "https://rsshub.app/github/trending/daily/all"
            check_interval_minutes: 60
            enabled: true
            max_entries: 10
            tags: ["github", "opensource"]
        default_check_interval_minutes: 30
        # AI Processing
        ai_enabled: true
        ai_summarization: true
        ai_classification: true
        ai_keyword_extraction: false
        ai_max_summary_length: 150
        # Aggregation
        aggregation_enabled: true
        aggregation_max_entries: 5
        aggregation_window_minutes: 5
        # Notifications
        webhook_name: "default"
        card_template: "detailed"  # minimal, compact, detailed, full
        # Storage
        history_days: 7
        # Daily Report
        daily_report_enabled: true
        daily_report_time: "09:00"
        daily_report_ai_summary: true
        daily_report_max_entries: 20
        daily_report_include_trends: true

    # Example: System Monitor Plugin
    # - plugin_name: "system-monitor"
    #   enabled: true
    #   priority: 10
    #   settings:
    #     cpu_threshold: 80
    #     memory_threshold: 85

# ==============================================================================
# Logging Configuration
# ==============================================================================
# Configure logging level and file output.
logging:
  level: "INFO"  # Options: "DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  log_file: "logs/bot.log"  # Path to log file (null for console only)
  max_bytes: 10485760  # Max log file size (10MB)
  backup_count: 5      # Number of backup log files to keep

# ==============================================================================
# HTTP Client Configuration
# ==============================================================================
# Configure default timeout and retry behaviour for webhook requests.
http:
  timeout: 10.0   # Default HTTP timeout in seconds
  retry:
    max_attempts: 3
    backoff_seconds: 1.0
    backoff_multiplier: 2.0
    max_backoff_seconds: 30.0

ai:
  enabled: false
  model: "openai:gpt-4o"
  api_key: "${OPENAI_API_KEY:}"
  system_prompt: "You are a helpful AI assistant integrated with Feishu."
  default_persona: "default"
  personas:
    default:
      display_name: "Default"
      description: "General-purpose assistant"
      prompt: ""
      prompt_mode: "append"
    developer:
      display_name: "Developer"
      description: "Software engineering assistant"
      prompt: "You are a senior software engineer. Provide precise, actionable guidance with minimal fluff."
      prompt_mode: "append"
      temperature: 0.2

# ==============================================================================
# Templates
# ==============================================================================
# Define reusable message templates referenced by automations or plugins.
# Template content supports either Python "string.Template" placeholders
# (default engine) or str.format placeholders (set engine: "format").
templates:
  - name: "daily_summary"
    description: "Daily summary card"
    type: "card"
    engine: "string"
    content: |
      {
        "header": {
          "template": "blue",
          "title": {"tag": "plain_text", "content": "Daily Summary"}
        },
        "elements": [
          {
            "tag": "markdown",
            "content": "**Date:** ${date}\nTasks completed: ${completed}"
          }
        ]
      }

  - name: "alert"
    description: "Alert notification template"
    engine: "format"
    content: |
      üö® **Alert: {title}**

      **Severity:** {severity}
      **Time:** {timestamp}
      **Details:** {details}

      {action_required}

  - name: "task_complete"
    description: "Task completion notification"
    engine: "format"
    content: |
      ‚úÖ **Task Completed**

      **Task:** {task_name}
      **Duration:** {duration}
      **Status:** {status}

# ==============================================================================
# Task Templates
# ==============================================================================
# Create reusable task definitions with parameterized configurations.
task_templates:
  - name: "http_health_check"
    description: "Template for HTTP endpoint health checks"
    base_task:
      name: "template"
      enabled: true
      schedule:
        mode: "interval"
        arguments:
          minutes: 5
      actions:
        - type: "http_request"
          request:
            method: "GET"
            url: "${url}"
            timeout: 10
            save_as: "response"
        - type: "send_message"
          webhook: "default"
          message: "Health check for ${service_name}: ${status}"
      error_handling:
        on_failure: "notify"
        retry_on_failure: true
        max_retries: 3
        retry_delay: 60
    parameters:
      - name: "url"
        type: "string"
        required: true
        description: "URL to check"
      - name: "service_name"
        type: "string"
        required: true
        description: "Name of the service"
      - name: "status"
        type: "string"
        default: "OK"
        description: "Status message"

# ==============================================================================
# Automated Tasks
# ==============================================================================
# Define scheduled and event-driven tasks.
tasks:
  - name: "api_health_check"
    description: "Check API health every 5 minutes"
    enabled: false  # Set to true to enable
    schedule:
      mode: "interval"
      arguments:
        minutes: 5
    actions:
      - type: "http_request"
        request:
          method: "GET"
          url: "https://api.example.com/health"
          timeout: 10
          save_as: "health_response"
      - type: "send_message"
        webhook: "default"
        message: "API Health: ${health_response.status}"
    error_handling:
      on_failure: "notify"
      retry_on_failure: true
      max_retries: 3
      retry_delay: 60
    timeout: 30
    priority: 100

# ==============================================================================
# Automations
# ==============================================================================
# Declarative workflows that run on schedules or in response to events.
automations:
  - name: "daily-summary"
    description: "Send a summary every weekday at 9:30"
    enabled: false  # Set to true to enable
    trigger:
      type: "schedule"
      schedule:
        mode: "cron"
        arguments:
          day_of_week: "mon-fri"
          hour: "9"
          minute: "30"
    default_webhooks: ["default"]
    actions:
      - type: "http_request"
        request:
          method: "GET"
          url: "https://api.example.com/summary"
          save_as: "summary"
      - type: "send_template"
        template: "daily_summary"
        context:
          date: "${event_date}"
        webhooks: ["default"]

# ==============================================================================
# Event Server
# ==============================================================================
# Optional FastAPI server that receives Feishu webhook events and feeds them
# to automations and plugins for reactive behaviour.
event_server:
  enabled: false
  host: "0.0.0.0"
  port: 8000
  path: "/feishu/events"
  auto_start: true
  verification_token: null
  signature_secret: null

# ==============================================================================
# Message Bridge Configuration
# ==============================================================================
# Cross-platform message forwarding (e.g., QQ ‚Üî Feishu).
message_bridge:
  enabled: false
  default_format: "[{source}] {sender}: {content}"
  rate_limit_per_minute: 60
  retry_on_failure: true
  max_retries: 3

  rules:
    # Example: Forward QQ group messages to Feishu
    - name: "qq_to_feishu"
      enabled: false
      description: "Forward QQ group messages to Feishu webhook"
      source_provider: "qq_napcat"
      source_chat_type: "group"  # all, private, group
      source_chat_ids: []  # Empty means all chats
      target_provider: "feishu_default"
      target_chat_id: "default"
      include_sender_info: true
      message_prefix: "[QQËΩ¨Âèë] "
      forward_images: true
      keyword_blacklist: ["spam", "ÂπøÂëä"]

# ==============================================================================
# Message Providers Configuration
# ==============================================================================
# Configure different message providers for cross-platform communication.
providers:
  # Feishu webhook provider
  - name: "feishu_default"
    provider_type: "feishu"
    enabled: true
    webhook_url: "${FEISHU_WEBHOOK_URL}"
    webhook_secret: "${FEISHU_WEBHOOK_SECRET}"

  # QQ/Napcat provider (OneBot11 protocol) - Example
  # - name: "qq_napcat"
  #   provider_type: "napcat"
  #   enabled: false
  #   http_url: "http://127.0.0.1:3000"
  #   access_token: "${NAPCAT_ACCESS_TOKEN}"
  #   bot_qq: "123456789"
  #   default_target: "group:987654321"

# ==============================================================================
# Environment Configuration
# ==============================================================================
# Define environment-specific configurations.
environments:
  - name: "development"
    description: "Development environment"
    variables:
      LOG_LEVEL: "DEBUG"
    overrides:
      logging:
        level: "DEBUG"
      plugins:
        auto_reload: true

  - name: "production"
    description: "Production environment"
    variables:
      LOG_LEVEL: "WARNING"
    overrides:
      logging:
        level: "WARNING"
      plugins:
        auto_reload: false

# Active environment (set via environment variable or here)
active_environment: "${ENVIRONMENT:development}"

# Enable configuration hot-reload
config_hot_reload: true
