# Enhanced Configuration Example for Feishu Webhook Bot
# This file demonstrates all the new YAML configuration capabilities

# Webhook configurations
webhooks:
  - name: "default"
    url: "${FEISHU_WEBHOOK_URL}"  # Environment variable substitution
    secret: "${FEISHU_WEBHOOK_SECRET}"
    enabled: true

  - name: "alerts"
    url: "${FEISHU_ALERTS_WEBHOOK_URL}"
    enabled: true

# Scheduler configuration
scheduler:
  enabled: true
  timezone: "Asia/Shanghai"
  job_defaults:
    coalesce: true
    max_instances: 3
    misfire_grace_time: 60

# Plugin system configuration
plugins:
  enabled: true
  plugin_dir: "plugins"
  auto_reload: true
  reload_delay: 1.0
  
  # Plugin-specific settings
  plugin_settings:
    - plugin_name: "system-monitor"
      enabled: true
      priority: 10  # Load first
      settings:
        cpu_threshold: 80
        memory_threshold: 85
        disk_threshold: 90
        check_interval: 300
    
    - plugin_name: "daily-greeting"
      enabled: true
      priority: 50
      settings:
        morning_time: "09:00"
        evening_time: "18:00"
        custom_message: "Have a great day!"
    
    - plugin_name: "reminder"
      enabled: true
      priority: 100
      settings:
        reminders:
          - time: "10:00"
            message: "Stand-up meeting in 15 minutes"
          - time: "15:00"
            message: "Time for a break!"

# Logging configuration
logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  log_file: "logs/bot.log"
  max_bytes: 10485760  # 10MB
  backup_count: 5

# General settings
general:
  bot_name: "Feishu Bot"
  description: "Automated notification and task bot"
  version: "2.0.0"

# Message templates
templates:
  - name: "alert"
    engine: "format"
    content: |
      ðŸš¨ **Alert: {title}**
      
      **Severity:** {severity}
      **Time:** {timestamp}
      **Details:** {details}
      
      {action_required}

  - name: "task_complete"
    engine: "format"
    content: |
      âœ… **Task Completed**
      
      **Task:** {task_name}
      **Duration:** {duration}
      **Status:** {status}

# Task templates for reusable task definitions
task_templates:
  - name: "http_health_check"
    description: "Template for HTTP endpoint health checks"
    base_task:
      name: "template"
      enabled: true
      schedule:
        mode: "interval"
        arguments:
          minutes: 5
      actions:
        - type: "http_request"
          request:
            method: "GET"
            url: "${url}"
            timeout: 10
            save_as: "response"
        - type: "send_message"
          webhook: "default"
          message: "Health check for ${service_name}: ${status}"
      error_handling:
        on_failure: "notify"
        retry_on_failure: true
        max_retries: 3
        retry_delay: 60
    parameters:
      - name: "url"
        type: "string"
        required: true
        description: "URL to check"
      - name: "service_name"
        type: "string"
        required: true
        description: "Name of the service"
      - name: "status"
        type: "string"
        default: "OK"
        description: "Status message"

  - name: "database_backup"
    description: "Template for database backup tasks"
    base_task:
      name: "template"
      enabled: true
      cron: "0 2 * * *"  # Daily at 2 AM
      actions:
        - type: "python_code"
          code: |
            import subprocess
            result = subprocess.run(
                ["${backup_command}"],
                capture_output=True,
                text=True
            )
            context["backup_result"] = result.returncode == 0
        - type: "send_message"
          webhook: "alerts"
          message: "Backup ${database_name}: {'Success' if context.get('backup_result') else 'Failed'}"
      error_handling:
        on_failure: "notify"
        retry_on_failure: false
    parameters:
      - name: "database_name"
        type: "string"
        required: true
      - name: "backup_command"
        type: "string"
        required: true

# Automated tasks
tasks:
  - name: "api_health_check"
    description: "Check API health every 5 minutes"
    enabled: true
    schedule:
      mode: "interval"
      arguments:
        minutes: 5
    conditions:
      - type: "environment"
        environment: "production"
    actions:
      - type: "http_request"
        request:
          method: "GET"
          url: "https://api.example.com/health"
          timeout: 10
          save_as: "health_response"
      - type: "send_message"
        webhook: "default"
        message: "API Health: ${health_response.status}"
    error_handling:
      on_failure: "notify"
      retry_on_failure: true
      max_retries: 3
      retry_delay: 60
    timeout: 30
    priority: 100
    max_concurrent: 1
    context:
      service: "api"

  - name: "daily_report"
    description: "Send daily report at 9 AM"
    enabled: true
    cron: "0 9 * * *"
    conditions:
      - type: "day_of_week"
        days: ["monday", "tuesday", "wednesday", "thursday", "friday"]
    actions:
      - type: "plugin_method"
        plugin: "system-monitor"
        method: "get_system_stats"
        save_as: "stats"
      - type: "send_message"
        webhook: "default"
        template: "task_complete"
        template_vars:
          task_name: "Daily Report"
          duration: "N/A"
          status: "Generated"
    error_handling:
      on_failure: "log"
      retry_on_failure: false
    priority: 50

  - name: "cleanup_old_logs"
    description: "Clean up logs older than 30 days"
    enabled: true
    cron: "0 3 * * 0"  # Weekly on Sunday at 3 AM
    actions:
      - type: "python_code"
        code: |
          import os
          import time
          from pathlib import Path
          
          log_dir = Path("logs")
          cutoff_time = time.time() - (30 * 24 * 60 * 60)
          deleted_count = 0
          
          for log_file in log_dir.glob("*.log*"):
              if log_file.stat().st_mtime < cutoff_time:
                  log_file.unlink()
                  deleted_count += 1
          
          context["deleted_count"] = deleted_count
      - type: "send_message"
        webhook: "default"
        message: "Cleaned up ${deleted_count} old log files"
    error_handling:
      on_failure: "log"
      retry_on_failure: false

# Environment-specific configurations
environments:
  - name: "development"
    description: "Development environment"
    variables:
      FEISHU_WEBHOOK_URL: "https://open.feishu.cn/open-apis/bot/v2/hook/dev-webhook"
      FEISHU_ALERTS_WEBHOOK_URL: "https://open.feishu.cn/open-apis/bot/v2/hook/dev-alerts"
      LOG_LEVEL: "DEBUG"
    overrides:
      logging:
        level: "DEBUG"
      scheduler:
        enabled: true
      plugins:
        auto_reload: true

  - name: "staging"
    description: "Staging environment"
    variables:
      FEISHU_WEBHOOK_URL: "https://open.feishu.cn/open-apis/bot/v2/hook/staging-webhook"
      FEISHU_ALERTS_WEBHOOK_URL: "https://open.feishu.cn/open-apis/bot/v2/hook/staging-alerts"
      LOG_LEVEL: "INFO"
    overrides:
      logging:
        level: "INFO"
      plugins:
        auto_reload: false

  - name: "production"
    description: "Production environment"
    variables:
      FEISHU_WEBHOOK_URL: "https://open.feishu.cn/open-apis/bot/v2/hook/prod-webhook"
      FEISHU_ALERTS_WEBHOOK_URL: "https://open.feishu.cn/open-apis/bot/v2/hook/prod-alerts"
      LOG_LEVEL: "WARNING"
    overrides:
      logging:
        level: "WARNING"
        log_file: "/var/log/feishu-bot/bot.log"
      scheduler:
        enabled: true
      plugins:
        auto_reload: false

# Active environment (set via environment variable or here)
active_environment: "${ENVIRONMENT:development}"

# Enable configuration hot-reload
config_hot_reload: true

